#! /bin/sh

check_for_disk_argument(){
    if [[ $1 != "--disk" && -z $2 ]]; then
        echo which disk, use this format:
        echo ./install --disk $2
        exit 1
    fi
}

check_if_disk_exists(){
    if [ ! -b "$1" ]; then
        echo $1 disk does not exit
        exit 1
    fi
}

partition_disk_10Gswap(){
(
    echo g # Create a new empty partition table
    echo n # Add a new partition
    echo 1 # Partition number
    echo   # First sector (Accept default: 1)
    echo +512M # size of partition
    echo n # Add a new partition
    echo 2 # Partition number
    echo   # First sector (Accept default: 1)
    echo +10G # size of partition
    echo n # Add a new partition
    echo 3 # Partition number
    echo   # First sector (Accept default: 1)
    echo   # size of partition (Accept default: 1)
    echo t # set type of partition 
    echo 1 # select partition 1
    echo 1 # set type to efi partition 

    echo w # Write changes
) | fdisk $1
}

format_partitions(){
    echo creating file formats
    mkfs.vfat -F32 $11
    mkswap $12
    swapon $12
    mkfs.ext4 $13
}
mount_partitions(){
    echo Mounting partitions
    mount $13 /mnt
    mkdir /mnt/boot
    mkdir /mnt/boot/efi
    mount $11 /mnt/boot/efi
}
update_pacman_mirror(){
    ## Norway
    echo "Server = http://mirror.neuf.no/archlinux/\$repo/os/\$arch" | cat - /etc/pacman.d/mirrorlist > temp && mv temp /etc/pacman.d/mirrorlist
}

INSTALL_DISK=$2
check_for_disk_argument $1 $2
check_if_disk_exists $INSTALL_DISK 
timedatectl set-ntp true
partition_disk_10Gswap $INSTALL_DISK
format_partitions $INSTALL_DISK
mount_partitions $INSTALL_DISK
update_pacman_mirror()

#packstrap
pacstrap /mnt base base-devel vim

##GenfsTab
genfstab -U /mnt >> /mnt/etc/fstab

##copy script part 2 into /mnt
cp part2 /mnt/part2

arch-chroot /mnt ./part2

